from BSB.BSB_Align.ProcessSamReads import ProcessSamAlignment
import gzip
import os
import pickle
import subprocess
import unittest
import numpy as np
from BSB.BSB_Utils.UtilityFunctions import get_external_paths
from BSB.BSB_Align.Align import BisulfiteAlignmentAndProcessing

# get current directory

test_directory = os.path.dirname(os.path.realpath(__file__))
bsb_directory = '/'.join(test_directory.split('/')[:-1]) + '/'
bsbolt = f'{bsb_directory}BSBolt.py'
bt2, art = get_external_paths()
with open(f'{bsb_directory}Tests/TestData/BSB_Test_DB_S/genome_index.pkl', 'rb') as lo:
    contig_lens = pickle.load(lo)

test_1 = [({'QNAME': 'chr10-59770', 'FLAG': '77', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'AGACTATTAAAATTATAATACAAATATAGCTTAATTTATACCAAAAACCTTAAAATAACCTTTAAAAACTGAAAACAACCCCCAACTAACATCCAAACTCCACCTCCCAAATTCACACCATTCTC', 'QUAL': 'CCCCCDEGGGGGGGGGGGEGGFGFGGGGGGGG1GGGGGG1GGGGGGGGGGGGGGGG1G>GGG1GGGG9GF>@GGGGGBGGGGGG1GG=GGGGGGGGGFGEGGGGG@GGEG/GGGG.E@8CGGG:G', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '1', 'conversion_bases': 'C2T', 'mapping_reference': 'W_C2T'}, {'QNAME': 'chr10-59770', 'FLAG': '141', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'TAAAGATGTTTTTTTTTTTGTGTTTATATGTTTTTATTGTTTAATTTCTACTTGTTGGTGAGTAATGGCGTCATCTGTATTCATATTATACAGTGTTTTAGAAGGTCTTGGTGTTGTTTTAGGTT', 'QUAL': 'BCBCCGGGGF1G1GGGGGGGGGGGG<=GGEFG<G>GGGGGGGGGGGEGGGGFGGGBGGGGGGGGGGG0FGGGGGEGGG1G>/0GGGGGGGG::GGGFGGGGG@GGGGGGGGGGGCG0G@GGGG0G', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '1', 'conversion_bases': 'G2A', 'mapping_reference': 'W_C2T'}), ({'QNAME': 'chr10-59770', 'FLAG': '83', 'RNAME': 'chr10', 'POS': '360069', 'MAPQ': '255', 'CIGAR': '125M', 'RNEXT': '=', 'PNEXT': '359797', 'TLEN': '-397', 'SEQ': 'AGACTATTAAAATTATAATACAAATATAGCTTAATTTATACCAAAAACCTTAAAATAACCTTTAAAAACTGAAAACAACCCCCAACTAACATCCAAACTCCACCTCCCAAATTCACACCATTCTC', 'QUAL': 'G:GGGC8@E.GGGG/GEGG@GGGGGEGFGGGGGGGGG=GG1GGGGGGBGGGGG@>FG9GGGG1GGG>G1GGGGGGGGGGGGGGGG1GGGGGG1GGGGGGGGFGFGGEGGGGGGGGGGGEDCCCCC', 'SAM_TAGS': ['AS:i:0', 'XN:i:0', 'XM:i:0', 'XO:i:0', 'XG:i:0', 'NM:i:0', 'MD:Z:125', 'YS:i:0', 'YT:Z:CP'], 'read_group': '2', 'conversion_bases': 'G2A', 'mapping_reference': 'C_G2A'}, {'QNAME': 'chr10-59770', 'FLAG': '163', 'RNAME': 'chr10', 'POS': '359797', 'MAPQ': '255', 'CIGAR': '125M', 'RNEXT': '=', 'PNEXT': '360069', 'TLEN': '397', 'SEQ': 'TAAAGATGTTTTTTTTTTTGTGTTTATATGTTTTTATTGTTTAATTTCTACTTGTTGGTGAGTAATGGCGTCATCTGTATTCATATTATACAGTGTTTTAGAAGGTCTTGGTGTTGTTTTAGGTT', 'QUAL': 'BCBCCGGGGF1G1GGGGGGGGGGGG<=GGEFG<G>GGGGGGGGGGGEGGGGFGGGBGGGGGGGGGGG0FGGGGGEGGG1G>/0GGGGGGGG::GGGFGGGGG@GGGGGGGGGGGCG0G@GGGG0G', 'SAM_TAGS': ['AS:i:0', 'XN:i:0', 'XM:i:0', 'XO:i:0', 'XG:i:0', 'NM:i:0', 'MD:Z:125', 'YS:i:0', 'YT:Z:CP'], 'read_group': '2', 'conversion_bases': 'C2T', 'mapping_reference': 'C_G2A'})]
test_2 = [({'QNAME': 'chr10-59768', 'FLAG': '99', 'RNAME': 'chr10', 'POS': '315889', 'MAPQ': '255', 'CIGAR': '125M', 'RNEXT': '=', 'PNEXT': '316095', 'TLEN': '331', 'SEQ': 'GTTTCAAAAAATATTTTAATGTATTAAAAGTTATTAATAATAAATTTACAGTCAATATAATAATTATTTTATACTATTTAGAATGGTGATTATTAAAAAGTTAGGAAACAATTAGTTAGAGATTT', 'QUAL': 'BC3CBFGDGGGGGGGGFGGGGGGGDGGFGGGGGGGGGGGGGGGGGEGG>GGGGGGGG1GFGGGGGGGGGGFFGG>GGGGGGGGGGGGGGGGD:G0GGGGEGGGGGGGCACGGGCGGGGGGGGGGG', 'SAM_TAGS': ['AS:i:0', 'XN:i:0', 'XM:i:0', 'XO:i:0', 'XG:i:0', 'NM:i:0', 'MD:Z:125', 'YS:i:-3', 'YT:Z:CP'], 'read_group': '1', 'conversion_bases': 'C2T', 'mapping_reference': 'W_C2T'}, {'QNAME': 'chr10-59768', 'FLAG': '147', 'RNAME': 'chr10', 'POS': '316095', 'MAPQ': '255', 'CIGAR': '125M', 'RNEXT': '=', 'PNEXT': '315889', 'TLEN': '-331', 'SEQ': 'GATACTTGACACCCAAAACTTTTAATTAAAACAAAATTTCACCATATTAACCAAACTAATCTTAAACTCAAATTAAAAAACACTCTACAAAATATTATCCAGAAAAACTTCCCCAATCTTCTACC', 'QUAL': 'GGGFBGDGGGBGGGGGGGGGGGGGGG:G;GGGGG1GGFG1GGGGGGGGGCFGEDGGG>EGGGGGGGGGGGGGGBGGGGGGG=GGGGGGGGGCGGGGG:1GGGGGGGGCGGGGGGGGGD1GB?BCB', 'SAM_TAGS': ['AS:i:-3', 'XN:i:0', 'XM:i:1', 'XO:i:0', 'XG:i:0', 'NM:i:1', 'MD:Z:98T26', 'YS:i:0', 'YT:Z:CP'], 'read_group': '1', 'conversion_bases': 'G2A', 'mapping_reference': 'W_C2T'}), ({'QNAME': 'chr10-59768', 'FLAG': '77', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'GTTTCAAAAAATATTTTAATGTATTAAAAGTTATTAATAATAAATTTACAGTCAATATAATAATTATTTTATACTATTTAGAATGGTGATTATTAAAAAGTTAGGAAACAATTAGTTAGAGATTT', 'QUAL': 'BC3CBFGDGGGGGGGGFGGGGGGGDGGFGGGGGGGGGGGGGGGGGEGG>GGGGGGGG1GFGGGGGGGGGGFFGG>GGGGGGGGGGGGGGGGD:G0GGGGEGGGGGGGCACGGGCGGGGGGGGGGG', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '2', 'conversion_bases': 'G2A', 'mapping_reference': 'W_G2A'}, {'QNAME': 'chr10-59768', 'FLAG': '141', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'GATACTTGACACCCAAAACTTTTAATTAAAACAAAATTTCACCATATTAACCAAACTAATCTTAAACTCAAATTAAAAAACACTCTACAAAATATTATCCAGAAAAACTTCCCCAATCTTCTACC', 'QUAL': 'BCB?BG1DGGGGGGGGGCGGGGGGGG1:GGGGGCGGGGGGGGG=GGGGGGGBGGGGGGGGGGGGGGE>GGGDEGFCGGGGGGGGG1GFGG1GGGGG;G:GGGGGGGGGGGGGGGBGGGDGBFGGG', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '2', 'conversion_bases': 'C2T', 'mapping_reference': 'W_G2A'})]
test_3 = [({'QNAME': 'chr10-59766', 'FLAG': '77', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'AGGGGTGGGTAGAGAGAGAGAAAGTGGAGAGGAGGAGGAGAAGTCATAATTAAGTAATGTATGTGGTAATTAATATGAAAAGTAATTTTTTTAATAATACTTTGGGAGGTTGAAGTGGGAGAATT', 'QUAL': 'BCCCBCGGGGGGGGGGGDGFGGGGGGGFGGGGGGGGGGGGE0GGG/FCCGGGCCGGGFGGGGGFGGGGGCDGDGGGG:GGGGGGGGGGGG0FGGGGGGGGGGGGGGGGGGGGG.GCGDGGGGBGD', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '1', 'conversion_bases': 'C2T', 'mapping_reference': 'W_C2T'}, {'QNAME': 'chr10-59766', 'FLAG': '141', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'GCACAAACTATTCCAATATACTCTACCTCAATATACCTTCCCAACAAAACCGACCCCAAAACCCCGACTAAAAGACTTAATAAAAAAACTCAACCATTCCCTTAAAAAAAATCAGCCTCTATACA', 'QUAL': 'B<3CCGGG@GGGGGGGGGGGGGGFGGGGGGGFGG:G<GGEGGG:GGGGF0GFGGGGGGGGG1G0GGGG>FGGGGGGGGGGGGEGFGG0GGGGGEGGGGG.GEGGGGEGGGGBGGGGGGGGG@=EG', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '1', 'conversion_bases': 'G2A', 'mapping_reference': 'W_C2T'}), ({'QNAME': 'chr10-59766', 'FLAG': '77', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'AGGGGTGGGTAGAGAGAGAGAAAGTGGAGAGGAGGAGGAGAAGTCATAATTAAGTAATGTATGTGGTAATTAATATGAAAAGTAATTTTTTTAATAATACTTTGGGAGGTTGAAGTGGGAGAATT', 'QUAL': 'BCCCBCGGGGGGGGGGGDGFGGGGGGGFGGGGGGGGGGGGE0GGG/FCCGGGCCGGGFGGGGGFGGGGGCDGDGGGG:GGGGGGGGGGGG0FGGGGGGGGGGGGGGGGGGGGG.GCGDGGGGBGD', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '2', 'conversion_bases': 'G2A', 'mapping_reference': 'W_G2A'}, {'QNAME': 'chr10-59766', 'FLAG': '141', 'RNAME': '*', 'POS': '0', 'MAPQ': '0', 'CIGAR': '*', 'RNEXT': '*', 'PNEXT': '0', 'TLEN': '0', 'SEQ': 'GCACAAACTATTCCAATATACTCTACCTCAATATACCTTCCCAACAAAACCGACCCCAAAACCCCGACTAAAAGACTTAATAAAAAAACTCAACCATTCCCTTAAAAAAAATCAGCCTCTATACA', 'QUAL': 'B<3CCGGG@GGGGGGGGGGGGGGFGGGGGGGFGG:G<GGEGGG:GGGGF0GFGGGGGGGGG1G0GGGG>FGGGGGGGGGGGGEGFGG0GGGGGEGGGGG.GEGGGGEGGGGBGGGGGGGGG@=EG', 'SAM_TAGS': ['YT:Z:UP'], 'read_group': '2', 'conversion_bases': 'C2T', 'mapping_reference': 'W_G2A'})]


process = ProcessSamAlignment(sam_reads=test_2, contig_lens=contig_lens)